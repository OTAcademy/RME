name: 'ü§ñ AI Pull Request Reviewer'

on:
  pull_request_target:
    types: ['opened', 'synchronize', 'reopened']
  pull_request_review_comment:
    types: ['created']
  pull_request_review:
    types: ['submitted']
  issue_comment:
    types: ['created']
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to review'
        required: true
        type: 'number'

jobs:
  review-pr:
    if: |-
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'pull_request_target' &&
       (github.event.action == 'opened' || github.event.action == 'synchronize' || github.event.action == 'reopened')) ||
      (github.event_name == 'issue_comment' &&
        github.event.issue.pull_request &&
        contains(github.event.comment.body, '@ai-review') &&
        (github.event.comment.author_association == 'OWNER' ||
         github.event.comment.author_association == 'MEMBER' ||
         github.event.comment.author_association == 'COLLABORATOR')) ||
      (github.event_name == 'pull_request_review_comment' &&
        contains(github.event.comment.body, '@ai-review') &&
        (github.event.comment.author_association == 'OWNER' ||
         github.event.comment.author_association == 'MEMBER' ||
         github.event.comment.author_association == 'COLLABORATOR')) ||
      (github.event_name == 'pull_request_review' &&
        contains(github.event.review.body, '@ai-review') &&
        (github.event.review.author_association == 'OWNER' ||
         github.event.review.author_association == 'MEMBER' ||
         github.event.review.author_association == 'COLLABORATOR'))
    
    timeout-minutes: 15
    runs-on: 'ubuntu-latest'
    
    permissions:
      contents: 'read'
      pull-requests: 'write'
      issues: 'write'
      id-token: 'write'
    
    steps:
      - name: 'Checkout PR code'
        uses: 'actions/checkout@v5'
        with:
          token: '${{ secrets.GITHUB_TOKEN }}'
          fetch-depth: 1
          ref: ${{ github.event.pull_request.head.sha || github.sha }}

      - name: 'Determine PR context'
        id: 'pr_context'
        env:
          COMMENT_BODY: '${{ github.event.comment.body || github.event.review.body || '''' }}'
        run: |-
          case "${{ github.event_name }}" in
            workflow_dispatch)
              PR_NUMBER="${{ github.event.inputs.pr_number }}"
              ;;
            pull_request_target)
              PR_NUMBER="${{ github.event.pull_request.number }}"
              ;;
            issue_comment)
              PR_NUMBER="${{ github.event.issue.number }}"
              ;;
            pull_request_review_comment|pull_request_review)
              PR_NUMBER="${{ github.event.pull_request.number }}"
              ;;
          esac
          
          echo "pr_number=$PR_NUMBER" >> "$GITHUB_OUTPUT"
          
          if [[ -n "$COMMENT_BODY" ]]; then
            INSTRUCTIONS=$(echo "$COMMENT_BODY" | sed 's/.*@ai-review//' | xargs)
            echo "additional_instructions=$INSTRUCTIONS" >> "$GITHUB_OUTPUT"
          fi

      - name: 'Run AI PR Review'
        uses: 'anthropics/claude-code-action@v1'
        env:
          GITHUB_TOKEN: '${{ secrets.GITHUB_TOKEN }}'
          GH_TOKEN: '${{ secrets.GITHUB_TOKEN }}'
          PR_NUMBER: '${{ steps.pr_context.outputs.pr_number }}'
          ADDITIONAL_INSTRUCTIONS: '${{ steps.pr_context.outputs.additional_instructions }}'
          REPOSITORY: '${{ github.repository }}'
          
          # Anthropic API Configuration
          ANTHROPIC_AUTH_TOKEN: '${{ secrets.ANTHROPIC_AUTH_TOKEN }}'
          ANTHROPIC_BASE_URL: '${{ secrets.ANTHROPIC_BASE_URL }}'
          ANTHROPIC_API_KEY: '${{ secrets.ANTHROPIC_AUTH_TOKEN }}'
          API_TIMEOUT_MS: '3000000'
          CLAUDE_CODE_DISABLE_NONESSENTIAL_TRAFFIC: '1'
        
        with:
          anthropic_api_key: '${{ secrets.ANTHROPIC_AUTH_TOKEN }}'
          github_token: '${{ secrets.GITHUB_TOKEN }}'
          claude_args: |
            --allowedTools "mcp__github_inline_comment__create_inline_comment,Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Bash(git *),Bash(cat *),Read,Write,Glob,Grep"
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ steps.pr_context.outputs.pr_number }}

            # üî• RME CODE REVIEWER - wxWidgets/C++20/OpenGL

            ## STEP 1: READ THE STYLEGUIDE (MANDATORY)
            ```bash
            cat .gemini/styleguide.md
            cat .agent/rules/wxwidgets.md
            cat .agent/rules/cpp_style.md
            ```
            **THESE ARE THE RULES. EVERY LINE OF CODE MUST COMPLY.**

            ## YOUR ROLE: CODE REVIEWER FOR RME MODERNIZATION
            You are a senior C++20/wxWidgets engineer reviewing for:
            - SOLID principles (especially Single Responsibility)
            - wxWidgets best practices (wxWrapSizer for tilesets!)
            - C++20 features (smart pointers, concepts, format)
            - OpenGL modernization (RAII wrappers)
            
            ## STEP 2: GET PR DIFF
            ```bash
            gh pr diff $PR_NUMBER
            ```

            ## STEP 3: REVIEW AGAINST RULES

            For EACH violation:
            1. **File + Line number**
            2. **Code snippet** showing the violation
            3. **Rule citation** from styleguide or rules
            4. **Fixed code**

            ## SEVERITY LEVELS
            - üî¥ **CRITICAL**: wxGridSizer for tilesets, raw new/delete, Application.cpp logic
            - üü° **HIGH**: SOLID violations, missing RAII, code duplication
            - üü¢ **MEDIUM**: Missing C++20 features, style issues

            ## OUTPUT FORMAT

            Create review.md then post:
            ```bash
            gh pr comment $PR_NUMBER --body-file review.md
            ```

            Structure:
            ```markdown
            # üîç RME Code Review

            ## üìã VERDICT: [APPROVED ‚úÖ / CHANGES REQUESTED ‚ùå]

            **Issues:** X üî¥ Critical | Y üü° High | Z üü¢ Medium

            ---

            ## üîç FINDINGS

            ### üìÅ `[filename.cpp]` (Lines X-Y)

            #### ‚ùå VIOLATION: [Rule Name]

            **Current:**
            ```cpp
            // code from PR
            ```

            **Rule:** "[Quote from styleguide]"

            **Fixed:**
            ```cpp
            // corrected code
            ```

            ---

            ## ‚úÖ POSITIVE ASPECTS
            - [Good practices found]
            ```

            **BE CONSTRUCTIVE. FOCUS ON MODERNIZATION.**
