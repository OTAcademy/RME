# RME wxWidgets/OpenGL Code Review Configuration
# Reviewer: C++20 modernization, wxWidgets best practices, SOLID principles, OpenGL upgrade path

mention_triggers = ["gito", "bot", "ai", "/fix"]
collapse_previous_code_review_comments = true

# GitHub PR Report Template
report_template_md = """
<h2>{{ HTML_TEXT_ICON }} Code Review â€” RME Modernization</h2>

{% if report.summary -%}
{{ report.summary }}
{%- endif %}

{% if report.total_issues > 0 -%}
**ðŸ”´ {{ report.total_issues }} issue{{ 's' if report.total_issues != 1 else '' }}** requiring attention across {{ report.number_of_processed_files }} file{{ 's' if report.number_of_processed_files != 1 else '' }}.
{%- else -%}
**âœ… Acceptable** â€” {{ report.number_of_processed_files }} file{{ 's' if report.number_of_processed_files != 1 else '' }} reviewed.
{%- endif -%}

{%- for issue in report.plain_issues -%}
{{"\\n"}}---
{{"\\n"}}## `#{{ issue.id}}` {{ issue.title }}
{{"\\n"}}ðŸ“ [{{ issue.file }}{%- if issue.affected_lines -%}:{%- for i in issue.affected_lines -%}L{{ i.start_line }}{%- if i.end_line != i.start_line -%}-L{{ i.end_line }}{%- endif -%}{%- if loop.last == false -%},{%- endif -%}{%- endfor -%}{%- endif -%}]({{ issue.github_code_link(github_env) }})

{{"\\n"}}### Problem
{{ issue.details }}

{{"\\n"}}**Classification:** `{{ ', '.join(issue.tags) }}`
{%- for i in issue.affected_lines -%}
{%- if i.affected_code %}

### Current Code
```{{ i.syntax_hint }}
{{ i.affected_code }}
```
{%- endif -%}
{%- if i.proposal %}

### Corrected Implementation
```{{ i.syntax_hint }}
{{ i.proposal }}
```
{%- endif -%}
{%- endfor -%}
{{ "\\n" }}
{%- endfor -%}
{{- HTML_CR_COMMENT_MARKER -}}
"""

retries = 3

# Main Review Prompt
prompt = """
{{ self_id }}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    RME CODE REVIEW TASK
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

You are reviewing changes to Remere's Map Editor, a C++/wxWidgets/OpenGL map editor.

CHANGES TO REVIEW:
{{ input }}

{% if file_lines -%}
FULL FILE CONTENT:
{{ file_lines }}
{%- endif %}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    REVIEW PHASES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PHASE 1: SOLID PRINCIPLES                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â–¡ Single Responsibility (SRP)
  â†’ Function > 50 lines? â†’ MAJOR: Split required
  â†’ File > 500 lines? â†’ MAJOR: Refactoring needed
  â†’ Class doing multiple unrelated things? â†’ Flag it

â–¡ Dependency Inversion (DIP)
  â†’ Concrete dependencies where abstraction works? â†’ Flag it
  
â–¡ Open/Closed (OCP)
  â†’ Hardcoded switch/case that should be polymorphic? â†’ Flag it

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PHASE 2: wxWidgets BEST PRACTICES                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â–¡ Tileset/Grid Layouts
  â†’ Using wxGridSizer for tilesets? â†’ CRITICAL: Must use wxWrapSizer
  â†’ Absolute positioning (SetPosition/SetSize)? â†’ MAJOR: Use sizers

â–¡ Event Handling
  â†’ New code using event tables? â†’ MINOR: Prefer Bind()

â–¡ Large Lists
  â†’ Adding 100+ items to list control? â†’ MAJOR: Use virtual list

â–¡ Thread Safety
  â†’ UI updates from worker thread? â†’ CRITICAL: Use CallAfter

â–¡ Performance
  â†’ Bulk updates without Freeze/Thaw? â†’ MINOR: Add Freeze/Thaw

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PHASE 3: C++20 MODERNIZATION                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â–¡ Memory Management
  â†’ Raw new/delete? â†’ MAJOR: Use smart pointers
  â†’ Missing RAII for resources? â†’ MAJOR

â–¡ Modern C++
  â†’ NULL instead of nullptr? â†’ MINOR: Modernize
  â†’ Missing override on virtual functions? â†’ MINOR
  â†’ C-style casts? â†’ MINOR: Use C++ casts
  â†’ Can use std::format, ranges, concepts? â†’ Enhancement

â–¡ Const Correctness
  â†’ Non-mutating method missing const? â†’ MINOR

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PHASE 4: OpenGL PATTERNS                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â–¡ Resource Lifecycle
  â†’ glGen*/glDelete* properly paired? â†’ MAJOR if not
  â†’ Missing RAII wrapper for GL objects? â†’ Enhancement

â–¡ State Management
  â†’ glEnable/glDisable balanced? â†’ Flag if not

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PHASE 5: CODE QUALITY                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â–¡ Duplication
  â†’ Similar code in 2+ places? â†’ MAJOR: Extract utility
  â†’ Copy-paste with minor changes? â†’ MAJOR: Parameterize

â–¡ Architecture
  â†’ Business logic in Application.cpp? â†’ CRITICAL
  â†’ UI code mixed with logic? â†’ MAJOR: Separate

{{ json_requirements }}

OUTPUT: JSON array of issues. Each issue needs:
- title, details, tags, severity (1-5), confidence (1-3)
- affected_lines with start_line, end_line, proposal

SEVERITY:
1 â€” Critical: Architecture, memory safety, wxWrapSizer missing
2 â€” Major: SOLID violation, raw new/delete, code duplication
3 â€” Minor: Style, modernization opportunity
4 â€” Trivial: Cosmetic
5 â€” Enhancement: Improvement opportunity

If no issues: []
"""

post_process = """
def is_valid_issue(issue):
    if issue.get("confidence", 4) > 2 or issue.get("severity", 5) > 3:
        return False
    for affected in issue.get("affected_lines", []):
        proposal = affected.get("proposal", "").strip()
        affected_code = affected.get("affected_code", "").strip()
        if proposal and affected_code and proposal == affected_code:
            return False
    return True

for fn in issues:
    issues[fn] = [i for i in issues[fn] if is_valid_issue(i)]
"""

summary_prompt = """
{{ self_id }}

Two-sentence technical assessment of this code change.
Sentence 1: Quality verdict and primary concern.
Sentence 2: Most critical improvement needed.

CHANGES:
{% for part in diff %}{{ part }}\\n{% endfor %}

ISSUES:
{{ issues | tojson(indent=2) }}

Output: Plain Markdown, no JSON.
"""

answer_github_comments = true

[prompt_vars]
self_id = """
You are a C++20/wxWidgets/OpenGL code reviewer for Remere's Map Editor.

Your expertise:
- wxWidgets: Layouts, sizers (wxWrapSizer for grids), events, threading
- C++20: Smart pointers, concepts, ranges, format, RAII
- OpenGL: Modern patterns, resource management, RAII wrappers
- SOLID: Single Responsibility is paramount

Project-specific rules:
- wxWrapSizer is MANDATORY for tileset grids (not wxGridSizer)
- Application.cpp: Only initialization, no business logic
- Smart pointers for ownership, raw pointers for observation
- Functions < 50 lines, files < 500 lines
- Incremental modernization: improve code when touching it
"""

json_requirements = """
âš ï¸ OUTPUT: VALID JSON ARRAY ONLY
"""

requirements = """
MANDATORY ENFORCEMENT:

WXWIDGETS:
- wxGridSizer for tilesets â†’ CRITICAL (must use wxWrapSizer)
- Absolute positioning â†’ MAJOR (use sizers)
- UI from worker thread â†’ CRITICAL (use CallAfter)

SOLID:
- SRP violation (>50 line function, >500 line file) â†’ MAJOR
- Business logic in Application.cpp â†’ CRITICAL

C++20:
- Raw new/delete â†’ MAJOR (use smart pointers)
- NULL â†’ MINOR (use nullptr)
- Missing override â†’ MINOR
"""
